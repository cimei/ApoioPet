{% extends "template_gov.html" %}
{% block content %}

<div class="col mb-5">
  <div class="br-breadcrumb">
    <ul class="crumb-list">
      <li class="crumb home"><a class="br-button circle" href="{{url_for('core.inicio')}}"><span class="sr-only">Página inicial</span><i class="fa fa-home"></i></a></li>
      <li class="crumb" data-active="active"><i class="icon fa fa-chevron-right"></i><span>Planos de Entrega</span>
      </li>
    </ul>
  </div>
</div>

<div class="container">
<div class="jumbotron">

  <div class="row">

    <div class="col-6">
      <h4>Lista de Planos de Entregas</h4>
    </div>
    <div class="col-5">
      {% if tipo == 'geral' %}
        <h4>Data de referência: <b>{{data_ref.strftime('%d/%m/%Y')}}</b></h4>
      {% endif %}  
    </div>
    <div class="col-1">
      <form class="needs-validation" method='POST' >

        {{ form.hidden_tag() }}

        <div class="row justify-content-around">

          {{ form.submit(class="br-button secondary mr-3") }}

        </div>

      </form>
    </div>

  </div>

  <caption>
    <div class="row">
        <div class="col-8">
          <p>Lista de <b>{{quantidade}}</b> planos de um total de <b>{{qtd_pes_total}}</b>  
        </div>
    </div>
  </caption>

  <div class="container" style="overflow-y:auto;">

    <table id="table"
          data-toggle="table"
          data-filter-control="true"
          data-show-search-clear-button="true"
          data-sortable="true"
          classes="table-sm"
          data-show-columns="true"
          data-show-columns-toggle-all="true"
          class="table table-striped table-hover table-sm">
      <caption>Planos de Entregas</caption>
      <thead>
        <tr>
          <th scope="col"><p align = "center">#</p></th>
          <th scope="col" data-field="Unidade" data-filter-control="input" data-sortable="true" data-filter-control-placeholder="Termo de pesquisa..."><p align = "center">Unidade</p></th>
          <th scope="col" data-field="Status" data-filter-control="input" data-sortable="true" data-filter-control-placeholder="Termo de pesquisa..."><p align = "center">Status</p></th>
          <th scope="col" data-sortable="true"><p align = "center">Início</p></th>
          <th scope="col" data-sortable="true"><p align = "center">Fim</p></th>
          <th scope="col"><p align = "center">Entregas</p></th>
          <th scope="col"><p align = "center">&emsp;PTs&emsp;</p></th>
          <th scope="col"><p align = "center">Avaliação</p></th>
        </tr>
      </thead>
      <tbody>

        {% for p in planos_entregas_todos %}

        <tr>
          <th scope="row"><p align = "center"> 
            {{planos_entregas_todos.index(p) + 1}}
          </p></th>
          <td><p align = "center"> 
              {% if p.sigla_pai %}
                {{p.sigla_pai}}/{{ p.sigla }}
              {% else %}
                {{ p.sigla }}
              {% endif %}   
          </p></td>
          <td><p align = "center">
              {% if p.status == 'INCLUIDO' %}
                {% if p.vencido == 's' %}
                  <span class="text-primary"><b>{{p.status}}</b></span>
                {% else %}
                  <span class="text-primary">{{p.status}}</span>
                {% endif %}  
              {% elif p.status == 'ATIVO' %}
                {% if p.vencido == 's' %}
                  <span class="text-danger"><b>{{p.status}}</b></span>
                {% else %}
                  <span class="text-success">{{p.status}}</span>
                {% endif %}
              {% elif p.status == 'HOMOLOGANDO' %}
                {% if p.vencido == 's' %}
                  <span class="text-warning"><b>{{p.status}}</b></span>
                {% else %}
                  <span class="text-warning">{{p.status}}</span>
                {% endif %}
              {% elif p.status == 'CANCELADO' %}
                <span class="text-secondary">{{p.status}}</span>
              {% elif p.status == 'AVALIADO' %}
                <span class="text-info">{{p.status}}</span>  
              {% else %}
                <span class="text-dark">{{p.status}}</span>
              {% endif %}
          
          </p></td>
          <td><p align = "center"> {{p.data_inicio.strftime('%d/%m/%Y')}} </p></td>
          <td><p align = "center"> 
            {% if p.vencido == 's' and (p.status == 'ATIVO' or p.status == 'HOMOLOGANDO' or p.status == 'INCLUIDO') %}
              <b>{{p.data_fim.strftime('%d/%m/%Y')}}</b>
            {% else %}  
              {{p.data_fim.strftime('%d/%m/%Y')}}
            {% endif %}   
          </p></td>

         <td><p align = "center"> 
                {% if p.qtd_entregas == None %}
                  0
                {% else %}
                  <a style="text-decoration: none" href="{{url_for('entregas.consulta_entregas',peId=p.id)}}" class="btn btn-outline-success btn-sm" role="button" aria-pressed="true">
                     {{p.qtd_entregas}} </a> 
                {% endif %}
     
          </p></td>

          <td>  
            <p align = "center"> 
              {% if p.qtd_planos_trab == None or p_qtd_planos_trab == 0 %}
                Não há
              {% else %}
                <a style="text-decoration: none" href="{{url_for('entregas.consulta_pts',peId=p.id)}}" class="btn btn-outline-success btn-sm" role="button" aria-pressed="true">
                  {{p.qtd_planos_trab}}</a>
              {% endif %}

            </p>
          </td> 
          
          {% if p.qtd_aval != None %}
            <td><p align = "center">

              <a href="#" data-bs-toggle='modal' data-bs-target='#aval_modal{{planos_entregas_todos.index(p) + 1}}' class="btn btn-outline-success btn-sm" role="button" aria-pressed="true">
                    {{p.qtd_aval}} </a> 
              
                {# modal visualização da avaliação do PE #}
                <div class="modal fade" tabindex="-1" role="dialog" id="aval_modal{{planos_entregas_todos.index(p) + 1}}">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h4 class="modal-title">Avaliação do PE {{planos_entregas_todos.index(p) + 1}}</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">

                        <ul class="list-group">

                          {% for a in avaliacoes_dados %}
                          {% if p.id == a.plano_entrega_id%}
                          <li class="list-group-item">
                            <p>Data: <b>{{ a.data_avaliacao.strftime('%d/%m/%Y') }}</b></p>
                            <p>Parecer: <b>{{ a.nota }}</b></p>
                            {% if a.justificativa == None %}
                              <p>Justificativa: <b>Não informada</b></p>
                            {% else %}  
                              <p>Justificativa: <b>{{ a.justificativa }}</b></p>
                            {% endif %} 
                            </li> 
                          {% endif %}
                          {% endfor %}

                        </ul>
                        
                      </div>
                      <div class="modal-footer">
                      </div>
                    </div>
                  </div>
                </div>                      
                
            </p></td>
            
          {% else %}
            <td>
              
              <p align = "center">
                Não há
              </p>
             
            </td>
            
          {% endif %}
              
        </tr>

        {% endfor %}

      </tbody>
    </table>

  </div>

</div>
</div>

{% endblock %}
